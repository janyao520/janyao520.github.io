<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>小耀Manager Page</title>
	<link rel="stylesheet" href="layui/css/layui.css">
	<link rel="stylesheet" href="css/manneger.css">
	</head>
	<body>

		
				 <!-- 表格书写的地方 -->
				 <table id="bookinfo" lay-filter="bookinfo"></table>

			
		<script src="layui/layui.js"></script>
		<!-- 三个js内容框 -->
		<!-- <script type="text/html" id="status_form">
		            <div class="layui-col-md10" style="margin-left: 35px;margin-top: 20px">
		                <form class="layui-form layui-form-pane" lay-filter="edit_form" action="">

							<div class="layui-inline" style="margin-left:50px;margin-top:60px;">
								<label class="layui-form-label">状态</label>
								<div class="layui-input-inline" style="width: 100px; margin-left:30px;">
									<select name="status" id="newsstatus">
									            <option value="">审核状态</option>
									            <option value="1">草稿</option>
									            <option value="2">审核通过</option>
									            <option value="3">审核驳回</option>
												<option value="4">归档</option>
									        </select>
								</div>		
							</div>
		
		                </form>
		
		            </div>
		    </script> -->
		
			<script type="text/html" id="edit_form">
			            <div class="layui-col-md10" style="margin-left: 35px;margin-top: 20px">
			                <form class="layui-form layui-form-pane" lay-filter="edit_form">
			                    <div class="layui-form-item">
			                        <label class="layui-form-label">商品编号</label>
			                        <div class="layui-input-block">
			                            <input type="text" name="ides" required  lay-verify="required" placeholder="请输入商品编号"
			                                   autocomplete="off" class="layui-input">
			                        </div>
			                    </div>
			                    <div class="layui-form-item">
			                        <label class="layui-form-label">商品名称</label>
			                        <div class="layui-input-block">
			                            <input type="text" name="name" required  lay-verify="required" placeholder="请输入商品名称"
			                                   autocomplete="off" class="layui-input">
			                        </div>
			                    </div>
								 <div class="layui-form-item">
								    <label class="layui-form-label">商品类型</label>
								    <div class="layui-input-block">
								      <select name="type" lay-verify="required" id="types">
								        <option value="">请选择商品类型</option>
								        <option value="1">饮料</option>
								        <option value="2">零食</option>
								        <option value="3">洗护用品</option>
								        <option value="4">家居用品</option>
								        <option value="5">日常百货</option>
										<option value="6">水果</option>
										<option value="7">肉类</option>
								      </select>
								    </div>
								  </div>
								<div class="layui-form-item">
								    <label class="layui-form-label">商品单价</label>
								    <div class="layui-input-block">
								        <input type="text" name="price" required  lay-verify="required" placeholder="请输入商品单价"
								               autocomplete="off" class="layui-input">
								    </div>
								</div>
								<div class="layui-form-item">
								    <label class="layui-form-label">库存量</label>
								    <div class="layui-input-block">
								        <input type="text" name="stock" required  lay-verify="required" placeholder="请输入库存量"
								               autocomplete="off" class="layui-input">
								    </div>
								</div>
								<div class="layui-form-item">
								   <label class="layui-form-label">供应商</label>
								   <div class="layui-input-block">
								     <select name="supplier" lay-verify="required" id='suppliers'>
								       <option value="">请选择供应商</option>
								       <option value="1">供应商A</option>
								       <option value="2">供应商B</option>
								       <option value="3">供应商C</option>
								       <option value="4">供应商D</option>
								       <option value="5">供应商E</option>
										
								     </select>
								   </div>
								 </div>

			                </form>
			
			            </div>
			    </script>
			
		<script type="text/html" id="rowTool">
			  <button type="button" class="layui-btn layui-btn-xs layui-btn-danger" lay-event="update">修改</button>
			  <!-- 审核可以修改成库存量问题 紧缺就标红 充裕就绿色 -->
			  <button type="button" class="layui-btn layui-btn-xs" lay-event="isgou">充足</button>
			 
			  <button type="button" class="layui-btn layui-btn-xs" lay-event="delete">删除</button>
			   <button type="button" class="layui-btn layui-btn-xs" lay-event="supplier">供应商详情</button>
		</script>
		<script type="text/html" id="tableTool">
			<!-- 三个按钮和搜索条件在同一个form里面 -->
			<form class="layui-form" lay-filter="searchFrom">
				<div class="layui-form-item" >
					
					 <div class="layui-inline">
						<label class="layui-form-label">商品名</label>
						<div class="layui-input-inline" style="width: 100px;">
							<input  type="text" id="shortname" name="shortname" class="layui-input"/>
						</div>		
					</div>
					
					<div class="layui-inline">
						<label class="layui-form-label">类型</label>
						<div class="layui-input-inline" style="width: 100px;">
							<select name="types" lay-verify="required" id="types">
							  <option value="">请选择</option>
							  <option value="1">饮料</option>
							  <option value="2">零食</option>
							  <option value="3">洗护用品</option>
							  <option value="4">家居用品</option>
							  <option value="5">日常百货</option>
							<option value="6">水果</option>
							<option value="7">肉类</option>
							</select>
						</div>		
					</div>
					
					 <div class="layui-inline">
								    <label class="layui-form-label">单价</label>
								    <div class="layui-input-inline" style="width: 100px;">
								      <input type="text" id='price_min' name="price_min" placeholder="￥" autocomplete="off" class="layui-input">
								    </div>
								    <div class="layui-form-mid">-</div>
								    <div class="layui-input-inline" style="width: 100px;">
								      <input type="text" id='price_max' name="price_max" placeholder="￥" autocomplete="off" class="layui-input">
								    </div>
								  </div>
					
					
					<div class="layui-inline">
						<div class="layui-input-inline" style="width: 100px;">
							
							<button type="button" id="btns" class="layui-btn"  lay-event="search" >
							<!-- 	省略了layuiadmin-button-btn属性 后期可判断是否有效 -->
							<i class="layui-icon layui-icon-search"></i>
							</button>
							            
							       
						</div>
					</div>
					
					<br/>
					<!-- 三个按钮 -->
					<button type="button" class="layui-btn layui-btn-radius" lay-event="new">新建</button>
				<!-- 	<button type="button" class="layui-btn layui-btn-warm layui-btn-radius" lay-event="archived">归档</button> -->
					<button type="button" class="layui-btn layui-btn-danger layui-btn-radius" lay-event="delall">批量删除</button>
				</div>
			</form>
		</script>
		
		<script type="text/html" id="detail">
			<div class="layui-col-md10" style="margin-left: 35px;margin-top: 20px">
			    <form class="layui-form layui-form-pane" lay-filter="detail">
			        <div class="layui-form-item">
			            <label class="layui-form-label">供货商编号</label>
			            <div class="layui-input-block">
			                <input type="text" name="suid" required  lay-verify="required"
			                       autocomplete="off" class="layui-input" readonly="true" style="background:#CCCCCC" >
			            </div>
			        </div>
					<div class="layui-form-item">
					    <label class="layui-form-label">供货商名称</label>
					    <div class="layui-input-block">
					        <input type="text" name="suname" required  lay-verify="required"
					               autocomplete="off" class="layui-input" readonly="true" style="background:#CCCCCC" >
					    </div>
					</div>
					<div class="layui-form-item">
					    <label class="layui-form-label">联系人</label>
					    <div class="layui-input-block">
					        <input type="text" name="sucontact" required  lay-verify="required"
					               autocomplete="off" class="layui-input" readonly="true" style="background:#CCCCCC" >
					    </div>
					</div>
					<div class="layui-form-item">
					    <label class="layui-form-label">电话</label>
					    <div class="layui-input-block">
					        <input type="text" name="suphone" required  lay-verify="required"
					               autocomplete="off" class="layui-input" readonly="true" style="background:#CCCCCC" >
					    </div>
					</div>
					<div class="layui-form-item">
					    <label class="layui-form-label">地址</label>
					    <div class="layui-input-block">
					        <input type="text" name="suaddr" required  lay-verify="required"
					               autocomplete="off" class="layui-input" readonly="true" style="background:#CCCCCC" >
					    </div>
					</div>
					
					
					</form>
					</div>
			
		</script>
		
		
		
		<script>
	
	
		
		layui.use(function(){
			var bool = false;
			var idNos=[];
			var table  =layui.table,$ = layui.$,productTypes,bookcol,bookcol2,suppliers,tableDatas=new Array(),layer =layui.layer,form=layui.form;
			
		
			
			$.ajax({
				url:"http://localhost:8080/liangyunyao/getAll",
				method:"get",
				async:false,
				dataType:"json",
				success:function(rs){
					tableDatas=rs;
					console.log(tableDatas)
				}
			});
			$.ajax({
				url:"http://localhost:8080/liangyunyao/getTypes",
				method:"get",
				async:false,
				dataType:"json",
				success:function(rs){
					productTypes = rs;
					console.log(productTypes)
				}
			});productTypes
			$.ajax({
				url:"http://localhost:8080/liangyunyao/getSupplier",
				method:"get",
				async:false,
				dataType:"json",
				success:function(rs){
					suppliers = rs;
					console.log(suppliers)
				}
			});
			
			table.render({
				elem:"#bookinfo",
				data:tableDatas,
				cols:[[
					{type: 'checkbox', fixed: 'left'},
					{type:'numbers',title:"序号"},
					// {field:"id",title:"商品编号",sort:true,width:80},
					{field:"name",title:"商品",sort:true},
		
					{field:"typeId",title:"商品类型",widt:"text",
					templet: function(d){
						$.each(productTypes,function(i,n){
							if(n.id == d.typeId){
								bookcol = n.name;
								
							}
						});
						return bookcol;
					}},
					{field:"price",title:"单价",width:120,edit:"text"},
					{field:"stock",title:"库存量",width:120,edit:"text"},
					{field:"supplierId",title:"供货商",width:100,edit:"text",
					templet: function(d){
						$.each(suppliers,function(i,n){
							if(n.id == d.supplierId){
								bookcol2 = n.name;
								
							}
						});
						return bookcol2;
					}},
					{title:"操作",templet:"#rowTool",fixed:"right"}
				]],
				parseData:function(res){
					return{
						"code":0,
						"count":res.length,
						"data":res
					}
				},
				page:true,
				toolbar:"#tableTool"
			});
			
			
			// 对行内按钮进行操作
			
			table.on("tool(bookinfo)",function(obj){
				var data = obj.data;
				 console.log(data)
				switch(obj.event){
					
					case "supplier":
						layer.open({
									   title:'供货商详细信息',
									   type:1,
									   btn: ['确定', '取消'],
									  
									   area:['420px','430px'],
									   content:$('#detail').html(),
									
									   success:function(layero,index){
										$.each(suppliers,function(i,n){
											if(n.id==data.supplierId){
												$('input[name=suid]').val(suppliers[i].id);
												$('input[name=suname]').val(suppliers[i].name)
												$('input[name=sucontact]').val(suppliers[i].contact)
												$('input[name=suphone]').val(suppliers[i].phone)
												$('input[name=suaddr]').val(suppliers[i].address)
												
											}
										});
										
										
										
										
										// form.render('select')                  
													  },
										yes:function(index, layero){

											layer.close(index);

											
										}
										   });
										   break;
					
					case "isgou":
					var btnStuta=$(this); //获得按钮对象
					layer.confirm("修改库存状态",{
										   btn:['库存不足',"充足"]
					},function(index){
										   btnStuta.html("无库存");
										   btnStuta.removeClass("layui-btn-danger");
										   btnStuta.addClass("layui-btn-warm");
										   layer.close(index);
					},function(index){
										    btnStuta.html("库存充足");
											btnStuta.removeClass("layui-btn-danger");
											btnStuta.removeClass("layui-btn-warm");
											layer.close(index);
					});
		// 			var btnStatus=$(this);  
					  
		// 			   layer.open({
		// 				   title:'审核状态',
		// 				   type:1,
		// 				   btn: ['确定', '取消'],
		// 				   area:['420px','330px'],
		// 				   content:$('#status_form').html(),
		// 				   success:function(){
							   
		// 					   console.log(data.status)
		// 					   //此语句对上面的表格头的select也生效了
		// 					   $("select option[value='"+data.status+"']").attr("selected",true);
		// 					  // $('newsstatus').val(data.status); 
		// 					 form.render();  
		// 				   },
		// 				   yes:function(index){
							 
		// 					   var newData=table.cache['bookinfo']; //获取当前表格的数据
							   
		// 					   $.each(newData,function(i,n){
		// 					   	if(data.id==n.id){
		// 							var selectedStatus = $("#newsstatus").val();
		// 							console.log(selectedStatus)
		// 							n.status = 1; //
		// 							//console.log(n.status)
									
		// 						 }
		// 						})
								
								
		// 						btnStatus.html("已审核")
		// 						console.log(btnStatus)
		// 						btnStatus.removeClass("layui-btn-danger");
		// 						btnStatus.addClass("layui-btn-warm");
		// 						layer.close(index);
		// 						table.reload("bookinfo",{
		// 						data:newData
		// 						});
								
  
		// 				   }
						   
		// 			   });

					 break;
					 
					//  case "archived":
					//  console.log("归档")
					 
					//  if(bool==false){
					//  var btnStatus=$(this); //获得按钮对象
					//  btnStatus.html("已归档")
					//  btnStatus.removeClass("layui-btn-danger");
					//  btnStatus.addClass("layui-btn-warm");
					//  //bool=true;
					//  var datas = obj.data
					//  console.log(datas.id)
					//  idNos.push(datas.id)
					//  console.log(idNos)
					 
					//  }
					//  else{
					// 	var btnStatus=$(this);
					// 	btnStatus.html("归档")
					// 	btnStatus.removeClass("layui-btn-warm");
					// 	 bool = false;
					// 	var datas = obj.data
					// 	console.log(datas.id)
					// 	 idNos.splice($.inArray(datas.id),3)
					// 	 console.log(idNos)
					//  }
					//  break;
					 
					case "delete": 
					   layer.confirm("确定删除吗？",function(index){
						   idd=data.id
						   $.ajax({
						   		type: 'post',
						   		url: 'http://localhost:8080/liangyunyao/deleteOne',
						   		data:{
						   			id:idd
						   		},
						   		success: function (result) {
						   			console.log(result)
						   		},
						   		error: function(data){
						   		  alert("操作异常");
						   		}
						   	});
						   
						   layer.close(index);
						   window.location.reload("bookinfo")
					   });
					break;
					
					case "update":
						var data = obj.data; 
						console.log(data)
						console.log(data.id)
						    layer.open({
										   title:'修改商品信息',
										   type:1,
										   btn: ['确定', '取消'],
										  
										   area:['420px','430px'],
										   content:$('#edit_form').html(),
										
										   success:function(layero,index){
											
										   	$('input[name=ides]').val(data.id);
											$('input[name=name]').val(data.name)
											$('select[name=type]').val(data.typeId)
											$('input[name=price]').val(data.price)
											$('input[name=stock]').val(data.stock)
											$('select[name=supplier]').val(data.supplierId)
											
										   	form.render('select')                  
										                  },
											yes:function(index, layero){
												
												var id = $('input[name=ides]').val()
												var name = $('input[name=name]').val()
												var type=$('select[name=type]').val()
												var price =$('input[name=price]').val()
												var stock = $('input[name=stock]').val()
												var supplier = $('select[name=supplier]').val()
												console.log(name)
												//向后端发送更新数据请求
												$.post("http://localhost:8080/liangyunyao/update",{
													id:id,
													name:name,
													typeId:type,
													price:price,
													stock:stock,
													supplierId:supplier
												},function(data){
													console.log(data);
												});
												layer.close(index);
												window.location.reload("bookinfo")
												// var newData=table.cache['bookinfo']; //获取当前表格的数据===array
												// console.log(newData)
												// $.each(newData,function(i,n){
												// 	if(data.id==n.id){
														
												// 		n.name=$('input[name=name]').val()
												// 		n.typeId=$('select[name=type]').val()
												// 		n.price=$('input[name=price]').val()
												// 		n.stock=$('input[name=stock]').val()
												// 		n.supplierId=$('select[name=supplier]').val()
												// }})
												
												// table.reload("bookinfo",{
												// data:newData
												// });
												// layer.close(index);
												//  // window.location.reload ()
											}
						                       });
											   break;

				}
			});
			
			// 表头工具条
			
			table.on("toolbar(bookinfo)",function(obj){
				switch(obj.event){
					
					case "archived":
					console.log(idNos)
					var newData=table.cache['bookinfo'];
					if(idNos.length>0){
						layer.confirm("确定要进行归档嘛?",{icon:3,title:"提示信息"},function(index){
							var temp = [];
							$.each(newData,function(i,n){
								if($.inArray(n.id,idNos)!=-1){
									console.log(n.id)
									temp.push(n);
								}

									
						});
						
						newData = temp;
						console.log(newData)
						table.reload("bookinfo",{
							  data:newData
						  });
						  layer.close(index);
						});
					}else{
						layer.msg("请选中要进行归档的数据");
					}
					
					break;
					case "search": 
					
					
					//根据获取到的搜索类型来执行搜索
					var name = $("#shortname").val()
					var types = $("#types").val()
					var pricemin = $("#price_min").val()
					var pricemax = $("#price_max").val()
					console.log(name)
					console.log(types)
					console.log(pricemin)
					console.log(pricemax)
					//如果填入的条件均为空的话 则为查询全部数据
					$.get("http://localhost:8080/liangyunyao/select",{
						name:name,
						type:types,
						minprice:pricemin,
						maxprice:pricemax
					},function(res){
						console.log(res);
						table.reload("bookinfo",{
							  data:res
						  });
					})
					
					// //对获取到的搜索数据进行处理
					// var newData=table.cache['bookinfo']; 
					// console.log(newData)
					// if(type.length>0){
					// 	var temp = []
					// 	$.each(newData,function(i,n){
					// 		console.log(n.newsNo)
					// 		if(n.newsNo == type){
					// 			console.log("进来了")
					// 			temp.push(n);
					// 			console.log(temp)
					// 		}
							
					// 	});
					// 	newData = temp;
					// 	console.log(newData)
					// }
					// if(status.length>0){
					// 	var temp = []
					// 	$.each(newData,function(i,n){
					// 		if(n.status == status){
					// 			temp.push(n);
					// 		}
							
					// 	});
					// 	newData = temp;
					// }
					
					// if(ids.length>0){
					// 	var temp = [];
					// 	$.each(newData,function(i,n){
					// 		if(n.id == ids){
					// 			temp.push(n);
					// 		}
							
					// 	});
					// 	newData = temp;
					// }
					
					// if(title.length>0){
					// 	var temp = [];
					// 	$.each(newData,function(i,n){ //采用valueof来当作迷糊处理
					// 		if(n.title.indexOf(title)>-1){
					// 			temp.push((n));
					// 		}
					// 	});
					// 	newData = temp;
					// }
					// console.log(newData)
					// table.reload("bookinfo",{
					// 	  data:newData
					//   });
					 break;
					
					case "delall":
					//方式二
					// table.on('checkbox(bookinfo)',function(obj){
					// 	console.log(obj.data)
					// })
					    var checkstatus = table.checkStatus(obj.config.id);
						var idss=[];
						 console.log(checkstatus)
						var datalist = checkstatus.data
						console.log(datalist)
						if(datalist.length>0){
							layer.confirm("确定删除选中的新闻数据?",{icon:3,title:"提示信息"},function(index){
							$(datalist).each(function(i,n){
								idss.push(n.id)
								
							});
							console.log(idss)
							
							$.ajax({
									type: 'post',
									url: 'http://localhost:8080/liangyunyao/delete',
									data:{
										ids:idss
									},
									success: function (result) {
										console.log(result)
									},
									error: function(data){
									  alert("操作异常");
									}
								});

								layer.close(index);
								window.location.reload("bookinfo")
				
							})
						}else{
							layer.msg("请输入需要删除的行");
						}
						
					 break;
					
					case "new":
						var data = obj.data; 
						console.log(data)
						    layer.open({
										   title:'新建商品信息',
										   type:1,
										   btn: ['确定', '取消'],
										   area:['420px','430px'],
										   content:$('#edit_form').html(),
										   success:function(layero,index){
										
										   	form.render('select')                  
										    },
											yes:function(index, layero){
												
												var id = $('input[name=ides]').val()
												var name = $('input[name=name]').val()
												var type=$('select[name=type]').val()
												var price =$('input[name=price]').val()
												var stock = $('input[name=stock]').val()
												var supplier = $('select[name=supplier]').val()
												console.log(name)
												//向后端发送更新数据请求
												$.post("http://localhost:8080/liangyunyao/add",{
													id:id,
													name:name,
													typeId:type,
													price:price,
													stock:stock,
													supplierId:supplier
												},function(data){
													console.log(data);
												});
												layer.close(index);
												window.location.reload("bookinfo")
										
											// yes:function(index, layero){
												// var newData=table.cache['bookinfo']; //获取当前表格的数据===array
												// console.log(newData)
												// var id = $('input[name=ides]').val()
												
												// var newRow={
												// "id":id,
												// "newsNo":$('input[name=newsNo]').val(),
												// "title":$('input[name=title]').val(),
												// "content":$('input[name=content]').val(),
												// "status":$('input[name=status]').val(),
												// };
												// //将新一行放入数组中
												// newData.push(newRow);
												// console.log(newData)
												
												//刷新表格数据
											// 	table.reload("bookinfo");
											// 	layer.close(index);
											// }
						                       }});
											   break;
				}
			});
			

		});

		</script>
		
		</body>
</html>